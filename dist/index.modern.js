import e,{useContext as t,createContext as r,useReducer as a,useState as s,useEffect as o}from"react";import n from"auth0-js";function u(){return(u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e}).apply(this,arguments)}const i=(e,t)=>{switch(t.type){case"login":const{authResult:r,user:a}=t,s=1e3*r.expiresIn+(new Date).getTime();return"undefined"!=typeof localStorage&&(localStorage.setItem("useAuth:expires_at",JSON.stringify(s)),localStorage.setItem("useAuth:user",JSON.stringify(a))),u({},e,{user:a,expiresAt:s,authResult:r});case"logout":return"undefined"!=typeof localStorage&&(localStorage.removeItem("useAuth:expires_at"),localStorage.removeItem("useAuth:user")),u({},e,{user:{},expiresAt:null,authResult:null});case"stopAuthenticating":return u({},e,{isAuthenticating:!1});case"startAuthenticating":return u({},e,{isAuthenticating:!0});case"error":const{errorType:o,error:n}=t;return u({},e,{user:{},expiresAt:null,authResult:null,errorType:o,error:n});default:return e}},c=async({err:e,dispatch:t,auth0:r,authResult:a})=>{if(t({type:"stopAuthenticating"}),!(a&&a.accessToken&&a.idToken))return!!e&&(console.error(e),t({type:"error",error:e,errorType:"authResult"}),!1);try{return await(async({dispatch:e,auth0:t,authResult:r})=>new Promise((a,s)=>{t.client.userInfo(r.accessToken||"",(t,o)=>{t?(e({type:"error",errorType:"userInfo",error:t}),s(t)):(e({type:"login",authResult:r,user:o}),a(o))})}))({dispatch:t,auth0:r,authResult:a}),!0}catch(e){return!1}},l=()=>{const{state:e,dispatch:r,auth0:a,callback_domain:s,navigate:o,customPropertyNamespace:n}=t(p),u=()=>!!(e.expiresAt&&(new Date).getTime()<e.expiresAt);return{isAuthenticating:e.isAuthenticating,isAuthenticated:u,isAuthorized:t=>{const r=Array.isArray(t)?t:[t],a=e.user[(n+"/user_metadata").replace(/\/+user_metadata/,"/user_metadata")];return!(!u()||!a)&&r.some(e=>a.roles.includes(e))},user:e.user,userId:e.user?e.user.sub:null,authResult:e.authResult,login:()=>{a&&a.authorize()},signup:()=>{a&&a.authorize({mode:"signUp",screen_hint:"signup"})},logout:()=>{a&&a.logout({returnTo:s}),r({type:"logout"}),o("/")},handleAuthentication:({postLoginRoute:e="/"}={})=>{"undefined"!=typeof window&&(r({type:"startAuthenticating"}),a&&a.parseHash(async(t,s)=>{await c({err:t,authResult:s,dispatch:r,auth0:a}),o(e)}))}}};function h(){let e={};if("undefined"!=typeof localStorage){const t=new Date(JSON.parse(localStorage.getItem("useAuth:expires_at")||"0"));t>new Date&&(e={user:JSON.parse(localStorage.getItem("useAuth:user")||"{}"),expiresAt:t})}return u({},{user:{},expiresAt:null,isAuthenticating:!1},e)}const p=r({state:h(),dispatch:()=>{},auth0:null,callback_domain:"http://localhost:8000",customPropertyNamespace:"http://localhost:8000",navigate:e=>{}}),d=({children:t,navigate:r,auth0_audience_domain:l,auth0_domain:d,auth0_client_id:g,auth0_params:m,customPropertyNamespace:y})=>{const A="undefined"!=typeof window?`${window.location.protocol}//${window.location.host}`:"http://localhost:8000",f=new n.WebAuth(u({},{domain:d,clientID:g,redirectUri:A+"/auth0_callback",audience:`https://${l||d}/api/v2/`,responseType:"token id_token",scope:"openid profile email"},m)),[w,_]=a(i,h()),[S,R]=s({state:w,dispatch:_,auth0:f,callback_domain:A,customPropertyNamespace:y,navigate:r});return o(()=>{R(e=>u({},e,{state:w}))},[w]),o(()=>{_({type:"startAuthenticating"}),console.log("check session"),f.checkSession({},(e,t)=>{console.log("check session err",e),_({type:"stopAuthenticating"}),console.log(e),e?_({type:"error",errorType:"checkSession",error:e}):c({dispatch:_,auth0:f,authResult:t})})},[]),e.createElement(p.Provider,{value:S},t)};export{d as AuthProvider,l as useAuth};
//# sourceMappingURL=index.modern.js.map
